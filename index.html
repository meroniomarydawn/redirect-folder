<!DOCTYPE html>
<html lang="en">
<head>
  <title>Your Folders</title>
</head>
<body>
  <h1>Welcome, <%= user.username %>!</h1>
  <img src="<%= user.avatar %>" alt="Avatar" width="50">
  <a href="/logout">Logout</a>
  <h2>Create a New Folder</h2>
  <form action="/folders" method="POST" enctype="multipart/form-data">
    <input type="text" name="name" placeholder="Folder Name" required>
    <input type="file" name="icon">
    <button type="submit">Create</button>
  </form>
  <h2>Your Folders:</h2>
  <ul>
    <% folders.forEach(folder => { %>
      <li>
        <img src="<%= folder.icon %>" alt="Folder Icon" width="50">
        <a href="/folders/<%= folder._id %>"><%= folder.name %></a>
      </li>
    <% }) %>
  </ul>
</body>
</html>

require('dotenv').config();
const express = require('express');
const session = require('express-session');
const passport = require('passport');
const GitHubStrategy = require('passport-github2').Strategy;
const mongoose = require('mongoose');
const multer = require('multer');
const path = require('path');

// Initialize app and MongoDB
const app = express();
mongoose.connect('mongodb://localhost:27017/githubFolders', {
  useNewUrlParser: true,
  useUnifiedTopology: true,
});

// Schemas and Models
const userSchema = new mongoose.Schema({
  githubId: String,
  username: String,
  avatar: String,
});
const folderSchema = new mongoose.Schema({
  userId: String,
  name: String,
  icon: String,
  files: [String],
});

const User = mongoose.model('User', userSchema);
const Folder = mongoose.model('Folder', folderSchema);

// Configure Multer for file uploads
const upload = multer({ dest: 'uploads/' });

// Middleware
app.use(
  session({
    secret: 'your_secret_key',
    resave: false,
    saveUninitialized: true,
  })
);
app.use(passport.initialize());
app.use(passport.session());
app.set('view engine', 'ejs');
app.use(express.static('public'));

// Passport GitHub OAuth Strategy
passport.use(
  new GitHubStrategy(
    {
      clientID: process.env.GITHUB_CLIENT_ID,
      clientSecret: process.env.GITHUB_CLIENT_SECRET,
      callbackURL: 'http://localhost:3000/auth/github/callback',
    },
    async (accessToken, refreshToken, profile, done) => {
      let user = await User.findOne({ githubId: profile.id });
      if (!user) {
        user = await User.create({
          githubId: profile.id,
          username: profile.username,
          avatar: profile._json.avatar_url,
        });
      }
      return done(null, user);
    }
  )
);

passport.serializeUser((user, done) => {
  done(null, user.id);
});

passport.deserializeUser(async (id, done) => {
  const user = await User.findById(id);
  done(null, user);
});

// Routes
app.get('/', (req, res) => {
  if (req.isAuthenticated()) {
    return res.redirect('/folders');
  }
  res.render('index');
});

// GitHub Login
app.get('/auth/github', passport.authenticate('github', { scope: ['user:email'] }));

// GitHub Callback
app.get(
  '/auth/github/callback',
  passport.authenticate('github', { failureRedirect: '/' }),
  (req, res) => {
    res.redirect('/folders');
  }
);

// Logout
app.get('/logout', (req, res) => {
  req.logout((err) => {
    if (err) return next(err);
    res.redirect('/');
  });
});

// Display folders for logged-in user
app.get('/folders', async (req, res) => {
  if (!req.isAuthenticated()) {
    return res.redirect('/');
  }
  const folders = await Folder.find({ userId: req.user.id });
  res.render('folders', { user: req.user, folders });
});

// Create a new folder
app.post('/folders', upload.single('icon'), async (req, res) => {
  if (!req.isAuthenticated()) {
    return res.redirect('/');
  }
  const newFolder = new Folder({
    userId: req.user.id,
    name: req.body.name,
    icon: req.file ? `/uploads/${req.file.filename}` : '/default-icon.png',
    files: [],
  });
  await newFolder.save();
  res.redirect('/folders');
});

// Upload a file to a folder
app.post('/folders/:id/files', upload.single('file'), async (req, res) => {
  if (!req.isAuthenticated()) {
    return res.redirect('/');
  }
  const folder = await Folder.findById(req.params.id);
  if (folder.userId !== req.user.id) {
    return res.status(403).send('Unauthorized');
  }
  folder.files.push(`/uploads/${req.file.filename}`);
  await folder.save();
  res.redirect(`/folders/${req.params.id}`);
});

// View a folder and its files
app.get('/folders/:id', async (req, res) => {
  if (!req.isAuthenticated()) {
    return res.redirect('/');
  }
  const folder = await Folder.findById(req.params.id);
  if (folder.userId !== req.user.id) {
    return res.status(403).send('Unauthorized');
  }
  res.render('folder', { user: req.user, folder });
});

// Serve static files and uploads
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running at http://localhost:${PORT}`);
});







